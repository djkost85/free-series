<div class="container">
	<div class="well">
		<?php
			LANG::loadFile('season','season');
			
			$serieSID = 0;
			//if(isset($_COOKIE['id']))	$serieSID = intval($_COOKIE['id']);
			if(isset($_GET['id']))		$serieSID = intval($_GET['id']);
			if($serieSID < 0)			$serieSID = 0;
			//setcookie('id',intval($serieSID),time()+(60*60*24*7));//7 Tage

			$serieSSID = 1;
			//if(isset($_COOKIE['ssid']))	$serieSSID = intval($_COOKIE['ssid']);
			if(isset($_GET['ssid']))	
			{
				$serieSSID = intval($_GET['ssid']);
				//if(intval($serieSSID) != intval($_COOKIE['ssid']))$_COOKIE['eid'] = 0;
			}
			if($serieSSID < 0) $serieSSID = 1;
			//setcookie('ssid',intval($serieSSID),time()+(60*60*24*7));//7 Tage
			
			$serieEID = 1;
			//if(isset($_COOKIE['eid']))	$serieEID = intval($_COOKIE['eid']);
			if(isset($_GET['eid']))			$serieEID = intval($_GET['eid']);
			if($serieEID <= 0) $serieEID = 1;
			//setcookie('eid',intval($serieEID),time()+(60*60*24*7));//7 Tage
			
			$serieLID = 0;
			//if(isset($_COOKIE['serie_lid']))	$serieLID = intval($_COOKIE['serie_lid']);
			if(isset($_GET['serie_lid']))		$serieLID = intval($_GET['serie_lid']);
			if($serieLID < 0) $serieLID = 0;
			//setcookie('serie_hoster',intval($serieLID),time()+(60*60*24*7));//7 Tage
				
			$sql	= 'SELECT * FROM fs_series WHERE id='.intval($serieSID);
			$result	= SQL::sendQuery($sql);
			if(!mysql_num_rows($result)) echo '<div class="alert alert-error">'.LANG::getData('season')->error->serie_missing.' <a href="index.php?page=series.overview">'.LANG::getData('series')->back_to_series.'</a></div>';
			else
			{
				$serie = mysql_fetch_array($result);
				if(empty($serie['cover']) || !file_exists('img/series/'.$serie['cover'].'.png')) $serie['cover'] = 'no_cover';
				if(!file_exists('img/series/cut_covers/'.$serie['cover'].'_200x200.png'));
				{
					if(file_exists('img/series/'.$serie['cover'].'.png'))
					{
						require_once('system/resources/SimpleImage.class.php');
						$image = new SimpleImage();
						$image->load('img/series/'.$serie['cover'].'.png');
						$image->resize(200,200);
						$image->save('img/series/cut_covers/'.$serie['cover'].'_200x200.png');
					}
				}
				if(!file_exists('img/series/cut_covers/'.$serie['cover'].'_600x600.png'));
				{
					if(file_exists('img/series/'.$serie['cover'].'.png'))
					{
						require_once('system/resources/SimpleImage.class.php');
						$image = new SimpleImage();
						$image->load('img/series/'.$serie['cover'].'.png');
						$image->resize(600,600);
						$image->save('img/series/cut_covers/'.$serie['cover'].'_600x600.png');
					}
				}				
				
				if(isset($_POST['action']) && isset($_POST['fs_token']) && USER::actionAuth())
				{
					if(!strcmp($_POST['action'],'serieRating') && USER::hasUserPermission('canRateSeries'))
					{
						$rating = intval($_POST['rating']);
						if($rating >= 1 && $rating <= 5)
						{
							$sql	= 'DELETE FROM fs_series_user_rating WHERE sid='.intval($serieSID).' AND userID='.intval(USER::$user['userID']);
							SQL::sendQuery($sql);
							$sql	= 'INSERT INTO fs_series_user_rating (sid,userID,rating,timestamp) VALUES ('.intval($serieSID).','.intval(USER::$user['userID']).','.intval($rating).','.time().')';
							SQL::sendQuery($sql);
							echo '
								<div class="alert alert-success">
								  <button type="button" class="close" data-dismiss="alert">×</button>
								  <strong>Bewertung:</strong> Du hast die Staffel mit <img src="img/icons/rating'.$rating.'.png"/> bewertet.
								</div>';
						}
					}
					if(!strcmp($_POST['action'],'addlink') && USER::hasUserPermission('canAddLinks'))
					{
						$total_posted = array('success'=>0,'failed'=>0);								
						$add_serieSID = intval($_POST['serieSID']);
						$sql	= 'SELECT * FROM fs_series WHERE id='.intval($add_serieSID);
						$result	= SQL::sendQuery($sql);
						if(mysql_num_rows($result))
						{
							$addlink_serie = mysql_fetch_array($result);
							$sql	= 'SELECT * FROM fs_series_seasons WHERE sid='.intval($add_serieSID);
							$result	= SQL::sendQuery($sql);
							$addlink_seasons = array();
							while($tmp_season = mysql_fetch_array($result)) $addlink_seasons[$tmp_season['ssid']] = $tmp_season;
							
							if(!isset($hosters))
							{
								$sql	= 'SELECT * FROM fs_series_link_hosters';
								$result	= SQL::sendQuery($sql);
								$hosters= array();
								while($tmp_hoster = mysql_fetch_array($result)) $hosters[$tmp_hoster['id']] = $tmp_hoster;
							}
							
							foreach($_POST['addLink'] as $addlink_info)
							{
								$addlink = array
									(
										'ssid'			=> intval(@$addlink_info['season']),
										'eid'			=> intval(@$addlink_info['episode']),
										'id'			=> @$addlink_info['id'],
										'hoster'		=> @$addlink_info['hoster'],
										'lid'			=> intval(@$addlink_info['lid']),
										'lid_subtitle'	=> intval(@$addlink_info['lid_subtitle']),
										'anon'			=> intval(@$addlink_info['anon'])
									);
								$addlink_info = print_r($addlink,true);
								if($addlink['ssid'] < 0 || $addlink['ssid'] > $addlink_serie['seasons'] || !isset($addlink_seasons[$addlink['ssid']]))
								{
									$total_posted['failed']++;
									echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Fehler!</strong> Die Staffel existiert nicht!<br/>
										'.$addlink_info.'
									</div>';
									print_r($addlink_seasons);
									continue;
								}
								if($addlink['eid'] < 0 || $addlink['eid'] > $addlink_seasons[$addlink['ssid']]['episodes'])
								{
									$total_posted['failed']++;
									echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Fehler!</strong> Die Episode existiert nicht!<br/>
										'.$addlink_info.'
									</div>';
									continue;
								}
								if($addlink['hoster'] <= 0 || !isset($hosters[$addlink['hoster']]))
								{
									$total_posted['failed']++;
									if($addlink['hoster'] == 0) echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Fehler!</strong> Du hast keinen Hoster ausgewählt!<br/>
										'.$addlink_info.'
									</div>';
									else echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Fehler!</strong> Der Hoster existiert nicht!<br/>
										'.$addlink_info.'
									</div>';
									continue;
								}
								if($addlink['lid'] < 0 || ($addlink['lid'] != 0 && !isset(LANG::$languages[$addlink['lid']])))
								{
									$total_posted['failed']++;
									echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Fehler!</strong> Die Sprache existiert nicht!<br/>
										'.$addlink_info.'
									</div>';
									continue;
								}
								if($addlink['lid_subtitle'] < 0 || ($addlink['lid_subtitle'] != 0 && !isset(LANG::$languages[$addlink['lid_subtitle']])))
								{
									$total_posted['failed']++;
									echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Fehler!</strong> Die Sprache existiert nicht!<br/>
										'.$addlink_info.'
									</div>';
									continue;
								}
								
								$link_id = null;
								$addlink_hoster = $hosters[$addlink['hoster']];										
								foreach(explode(';',$addlink['id']) as $link_part)
								{
									if(empty($link_part)) continue;
									$link_add = null;
									if(preg_match('~^'.sprintf($addlink_hoster['id_regex'],$addlink_hoster['id_len']).'$~',$link_part)) $link_add = $link_part;
									else
									{
										foreach(explode(';',$addlink_hoster['addlink_format']) as $valid_format)
										{
											if(empty($valid_format)) continue;
											$pattern = '~^'.sprintf($valid_format,'('.sprintf($addlink_hoster['id_regex'],$addlink_hoster['id_len']).')').'$~is';
											if(!preg_match($pattern,$link_part,$subpattern)) continue;
											$link_add = $subpattern[1];
										}
									}
									if(empty($link_add))
									{
										$total_posted['failed']++;
										echo '<div class="alert alert-error">
											<button type="button" class="close" data-dismiss="alert">×</button>
											<strong>Fehler!</strong> Das Format der ID ist falsch!<br/>
											'.$addlink_info.'
										</div>';
										$link_id = null;
										break;
									}
									$sql	= 'SELECT COUNT(*) FROM fs_series_links WHERE hoster='.intval($addlink['hoster']).' AND link_id LIKE "%'.mysql_real_escape_string($link_add).'%"';
									$result	= SQL::sendQuery($sql);
									if(mysql_result($result,0) >= 1)
									{
										echo '<div class="alert alert-error">
											<button type="button" class="close" data-dismiss="alert">×</button>
											<strong>Fehler!</strong> Der Link existiert schon!<br/>
											'.$addlink_info.'
										</div>';
										$link_id = null;
										break;
									}
									$sql	= 'SELECT COUNT(*) FROM fs_series_linksuggestions WHERE hoster='.intval($addlink['hoster']).' AND link_id LIKE "%'.mysql_real_escape_string($link_add).'%"';
									$result	= SQL::sendQuery($sql);
									if(mysql_result($result,0) >= 1)
									{
										echo '<div class="alert alert-error">
											<button type="button" class="close" data-dismiss="alert">×</button>
											<strong>Fehler!</strong> Der Link wurde schon vorgeschlagen!<br/>
											'.$addlink_info.'
										</div>';
										$link_id = null;
										break;
									}
									$link_id[] = $link_add;
								}
								if(isset($link_id))
								{
									$sql = 'INSERT INTO fs_series_linksuggestions (status,edited_by_id,edited_by_name,edited_time,sid,ssid,eid,lid,lid_subtitle,link_id,userID,userName,hoster,anon,timestamp) VALUES (0,0,"",0,'.intval($add_serieSID).','.intval($addlink['ssid']).','.intval($addlink['eid']).','.intval($addlink['lid']).','.intval($addlink['lid_subtitle']).',";'.mysql_real_escape_string(join(';',$link_id)).';",'.intval(USER::$user['userID']).',"'.mysql_real_escape_string(USER::$user['userName']).'",'.intval($addlink['hoster']).','.intval($addlink['anon']).','.time().')';
									SQL::sendQuery($sql);
									echo '<div class="alert alert-success">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Alles klar!</strong> Die Daten sind einwandfrei und werden von einem Teammitglied überprüft :)
									</div>';
								}
							}
						}
						else echo '<div class="alert alert-error">
							<button type="button" class="close" data-dismiss="alert">×</button>
							<strong>Fehler!</strong> Die Serie existiert nicht!
						</div>';
					}
					if(!strcmp($_POST['action'],'report_link') && USER::hasUserPermission('canReportLinks'))
					{
						$report_data = array
							(
								'lid'				=> intval(@$_POST['brokenLID']),
								'sid'				=> intval(@$_POST['brokenSID']),
								'ssid'				=> intval(@$_POST['brokenSSID']),
								'eid'				=> intval(@$_POST['brokenEID']),
								'reason'			=> intval(@$_POST['brokenReason']),
								'additional_info'	=> @$_POST['brokenAdditionalInformation']
							);
						if($report_data['lid'] >= 1 && $report_data['sid'] >= 1 && $report_data['ssid'] >= 1 && $report_data['eid'] >= 1 && $report_data['reason'] >= 1)
						{
							$sql	= 'SELECT COUNT(*) FROM fs_series_links WHERE id='.intval($report_data['lid']).' AND sid='.intval($report_data['sid']).' AND ssid='.intval($report_data['ssid']).' AND eid='.intval($report_data['eid']);
							$result	= SQL::sendQuery($sql);
							if(mysql_result($result,0) >= 1)
							{
								$sql	= 'SELECT COUNT(*) FROM fs_series_reported_links WHERE lid='.intval($report_data['lid']).' AND status=0';
								$result	= SQL::sendQuery($sql);
								if(mysql_result($result,0) >= 1) echo '
								<div class="alert alert-error">
									<button type="button" class="close" data-dismiss="alert">×</button>
									<strong>Fehler!</strong> Der Link wurde schon als defekt gemeldet!
								</div>';
								else
								{
									$sql	= 'INSERT INTO fs_series_reported_links (status,edited_by_id,edited_by_name,edited_time,sid,ssid,eid,lid,reason,additional_information,userID,userName,timestamp) VALUES (0,0,"",0,'.intval($report_data['sid']).','.intval($report_data['ssid']).','.intval($report_data['eid']).','.intval($report_data['lid']).','.intval($report_data['reason']).',"'.mysql_real_escape_string(substr($report_data['additional_info'],0,200)).'",'.intval(USER::$user['userID']).',"'.mysql_real_escape_string(USER::$user['userName']).'",'.time().')';
									SQL::sendQuery($sql);
									echo '<div class="alert alert-error">
										<button type="button" class="close" data-dismiss="alert">×</button>
										<strong>Vielen Dank!</strong> Du hast den Link als defekt gemeldet
									</div>';
								}
							}
						}
					}
				}
				if(isset($_GET['fs_token']) && isset($_GET['action']) && USER::actionAuth())
				{
					if(!strcmp($_GET['action'],'defav') && USER::hasUserPermission('canFavoriteSeries'))
					{
						$sql	= 'DELETE FROM fs_user_favorites WHERE userID='.intval(USER::$user['userID']).' AND sid='.intval($serieSID);
						$result	= SQL::sendQuery($sql);
						echo '
							<div class="alert alert-error">
								<button type="button" class="close" data-dismiss="alert">×</button>
								<strong>Achtung!</strong> Du hast die Serie von deinen Favoriten entfernt!
							</div>';
					}
					else if(!strcmp($_GET['action'],'fav') && USER::hasUserPermission('canFavoriteSeries'))
					{
						$sql	= 'DELETE FROM fs_user_favorites WHERE userID='.intval(USER::$user['userID']).' AND sid='.intval($serieSID);
						SQL::sendQuery($sql);
						$sql	= 'INSERT INTO fs_user_favorites (userID,sid,timestamp) VALUES ('.intval(USER::$user['userID']).','.intval($serieSID).','.time().')';
						SQL::sendQuery($sql);
						echo '
							<div class="alert alert-success">
								<button type="button" class="close" data-dismiss="alert">×</button>
								<strong>Glückwunsch!</strong> Du hast die Serie zu deinen Favoriten hinzugefügt!
							</div>';
					}
				}
				
				if(USER::isLoggedIn())
				{
					$sql	= 'SELECT * FROM fs_user_has_watched WHERE userID='.intval(USER::$user['userID']).' AND sid='.intval($serieSID);
					$result	= SQL::sendQuery($sql);
					$seasons_watched = array();
					while($tmp_watched = mysql_fetch_array($result))
					{
						@$seasons_watched[$tmp_watched['ssid']]['count'] += 1;
						$seasons_watched[$tmp_watched['ssid']]['episode'][$tmp_watched['eid']] = 1;
					}
				}
				
				
				if($serieSSID > $serie['seasons']) $serieSSID = $serie['seasons'];
				$sql = 'SELECT * FROM fs_series_seasons WHERE sid='.intval($serieSID);
				$result = SQL::sendQuery($sql);
				$seasons = array();
				while($tmp_season = mysql_fetch_array($result)) $seasons[$tmp_season['ssid']] = $tmp_season;
				
				echo '
				<div class="row-fluid">
					<div class="span3">
						<div class="zoomer" style="height:200px; width: 200px;">
							<div class="work">
								<a 	class="fancybox-button"
									rel="fancybox-button"
									title="'.htmlspecialchars($serie['name']).'"
									href="img/series/cut_covers/'.$serie['cover'].'_600x600.png">
									<div class="overlay-zoom">
										<img src="img/series/cut_covers/'.$serie['cover'].'_200x200.png" class="" alt="project 1">
										<div class="zoom-icon"></div>
									</div>
								</a>
								<a href="#" class="details">
									<div><b>'.htmlspecialchars($serie['name']).'</b></div>
								</a>
							</div>
						</div>';
						if(USER::isLoggedIn())
						{
							echo '<br/><br/>';
							if(USER::hasUserPermission('canFavoriteSeries'))
							{
								$sql	= 'SELECT COUNT(*) FROM fs_user_favorites WHERE userID='.intval(USER::$user['userID']).' AND sid='.intval($serieSID);
								$result	= SQL::sendQuery($sql);
								if(mysql_result($result,0) >= 1) echo '<a href="index.php?page=series.season&id='.intval($serieSID).'&ssid='.intval($serieSSID).'&fs_token='.USER::$user['fs_token'].'&action=defav"><span class="badge badge-success">Als Favorit markiert</span> ×</a>';
								else echo '<a href="index.php?page=series.season&id='.intval($serieSID).'&ssid='.intval($serieSSID).'&fs_token='.USER::$user['fs_token'].'&action=fav"><span class="badge">Als Favorit markieren</span></a>';
							}
							if(VALIDATION::canAccessPage(array('moderation'))) echo '<br/><a href="index.php?page=moderation.manageepisodes&id='.$serieSID.'&ssid='.intval(@$serieSSID).'"><span class="badge">Zu den Moderationstools</span></a>';
						}
					echo'
					</div>
					<div class="span4">
						<table class="table table-hover">';
							if(USER::isLoggedIn() && USER::hasUserPermission('canRateSeries'))
							{
								echo '<tr><td><strong>Deine Bewertung</strong></td><td>';
									$sql	= 'SELECT rating FROM fs_series_user_rating WHERE sid='.intval($serieSID).' AND userID='.USER::$user['userID'];
									$result	= SQL::sendQuery($sql);
									if(!mysql_num_rows($result)) $rating = 0;
									else $rating = intval(mysql_result($result,0));
									if(intval($rating) < 0 || intval($rating > 5)) $rating = 0;
									?>
										<script type="text/javascript" src="js/Rating.class.js"></script>
										<form method="post" action="#">
											<div>
												<input type="hidden" name="action"		value="serieRating"/>
												<input type="hidden" name="fs_token"	value="<?php echo USER::$user['fs_token']; ?>"/>
												<input type="hidden" name="sid"			value="<?php echo intval($serieSID); ?>"/>
												<input type="hidden" name="ssid"		value="<?php echo intval($serieSSID); ?>"/>
												<input type="hidden" id="serieRating"	name="rating" value="0"/>
												<span class="hidden" id="serieRatingSpan"></span>
												<noscript>
													<div>
														<select id="serieRatingSelect" name="rating">
															<option value="1">1</option>
															<option value="2">2</option>
															<option value="3">3</option>
															<option value="4">4</option>
															<option value="5">5</option>
														</select>
														<input type="image" class="inputImage" src="img/icons/submitS.png" alt="Absenden"/>
													</div>
												</noscript>
											</div>
										</form>
										<script type="text/javascript">
											//<![CDATA[
											new Rating('serieRating',<?php echo intval($rating); ?>);
											//]]
										</script>
									</td>
								</tr><?php
							}
							echo '<tr><td><strong>Metascore (#'.intval($serieSSID).')</strong></td><td>
								<span class="badge badge-';
								if(intval(@$seasons[$serieSSID]['metascore'])		<= 0)	echo 'info">unrated';
								else if(intval(@$seasons[$serieSSID]['metascore']) 	<= 40)	echo 'important">'.intval(@$seasons[$serieSSID]['metascore']).'/100';
								else if(intval(@$seasons[$serieSSID]['metascore']) 	<= 60)	echo 'warning">'.intval(@$seasons[$serieSSID]['metascore']).'/100';
								else														echo 'success">'.intval(@$seasons[$serieSSID]['metascore']).'/100';
								echo '
								</span>
							</td><tr>
							<tr><td><strong>'.LANG::getData('season')->general->userrating.'</strong></td><td>
								<img src="img/rating'.round(@$seasons[$serieSSID]['userrating']).'.png"/>
							</td><tr>
							<tr><td><strong>'.LANG::getData('season')->general->production.'</strong></td><td>';
								if(intval($serie['production_from'] >= 1000))
								{
									echo intval($serie['production_from']).'-';
									if(intval($serie['production_to'] >= 1000)) echo intval($serie['production_to']);
								}
								else echo 'Unbekannt';
							echo '</td><tr>
							<tr><td><strong>'.LANG::getData('season')->general->actors.'</strong></td><td>';
								foreach(explode(';',$serie['actors']) as $actor) if(!empty($actor)) echo '<span class="label label-info">'.htmlspecialchars($actor).'</span> ';
							echo '</td><tr>
							<tr><td><strong>'.LANG::getData('season')->general->director.'</strong></td><td>';
								foreach(explode(';',$serie['director']) as $director) if(!empty($director)) echo '<span class="label label-info">'.htmlspecialchars($director).'</span> ';
							echo '</td><tr>
							<tr><td><strong>'.LANG::getData('season')->general->authors.'</strong></td><td>';
								foreach(explode(';',$serie['author']) as $author) if(!empty($author)) echo '<span class="label label-info">'.htmlspecialchars($author).'</span> ';
							echo '</td><tr>
							<tr><td><strong>'.LANG::getData('season')->general->producer.'</strong></td><td>';
								foreach(explode(';',$serie['producer']) as $producer) if(!empty($producer)) echo '<span class="label label-info">'.htmlspecialchars($producer).'</span> ';
							echo '</td><tr>
						</table>
					</div>
					<div class="span5">
						<div class="service clearfix well">
							<h3>'.LANG::getData('season')->general->description.'</h3>
							<p>';
						define('DESCRIPTION_LEN',400);
						$content_len = strlen($serie['description']);
						echo htmlspecialchars(substr($serie['description'],0,DESCRIPTION_LEN));						
						if($content_len > DESCRIPTION_LEN)
						{
							echo '<a href="#modalDescription" data-toggle="modal">... '.LANG::getData('season')->general->more_text.'</a>
							<div id="modalDescription" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modalDescriptionLabel" aria-hidden="true">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
									<h3 id="modalDescriptionLabel">'.LANG::getData('season')->general->description.'</h3>
								</div>
								<div class="modal-body">
									<p>'.htmlspecialchars($serie['description']).'</p>
								</div>
								<div class="modal-footer">
									<button class="btn" data-dismiss="modal" aria-hidden="true">'.LANG::getData('season')->general->close.'</button>
								</div>
							</div>';
						}
					echo '</p>
						</div>
					</div>
				</div>
				<div class="row-fluid">
					<strong>'.LANG::getData('series')->general->seasons.'</strong> - ';
					for($i=1; $i<=$serie['seasons']; $i++)
					{
						echo '<a href="index.php?page=series.season&id='.$serieSID.'&ssid='.$i.'"><button type="button" class="btn';
							if($i == $serieSSID) echo ' btn-primary';
							else if(intval(@$seasons_watched[$i]['count']) >= intval(@$seasons[$i]['episodes']) && intval(@$seasons_watched[$i]['count']) >= 1) echo ' btn-success';
						echo '"> '.intval($i).' ('.intval(@$seasons[$i]['episodes']).')</button></a> ';
					}
				echo '</div><hr class="solid">';
				
				if(!isset($seasons[$serieSSID])) echo '<div class="alert alert-error">'.LANG::getData('season')->error->season_missing.' <a href="index.php?page=series.overview">'.LANG::getData('season')->general->back_to_series.'</a></div>';
				else
				{
					?>
					<div class="row-fluid">
						<div class="accordion" id="accordion">
							<div class="accordion-group">
								<div class="accordion-heading">
									<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseEpisodeList">
										<?php echo LANG::getData('series')->general->episodes; ?>
									</a>
								</div>
								<div id="collapseEpisodeList" class="accordion-body collapse<?php if(!isset($_GET['action']) || $_GET['action'] != 'view' || !USER::actionAuth()) echo ' in'; ?>">
									<div class="accordion-inner">
					<?php
					if($serieEID > $seasons[$serieSSID]['episodes']) $serieEID = $seasons[$serieSSID]['episodes'];
					$sql		= 'SELECT * FROM fs_series_seasons_episodes WHERE sid='.intval($serieSID).' AND ssid='.intval($serieSSID);
					$result		= SQL::sendQuery($sql);
					$episodes	= array();
					if(mysql_num_rows($result)) while($tmp_episode = mysql_fetch_array($result)) $episodes[$tmp_episode['eid']] = $tmp_episode;
					
					echo '<table class="table table-hover">
						<thead>
							<tr>
								<th width="10px">#</th>
								<th width="30px">'.LANG::getData('season')->episode->status.'</th>
								<th>'.LANG::getData('season')->episode->title.'</th>
								<th>'.LANG::getData('season')->episode->hoster.'</th>
							</tr>
						</thead>
						<tbody>';
					
					if(!isset($hosters))
					{
						$sql	= 'SELECT * FROM fs_series_link_hosters';
						$result	= SQL::sendQuery($sql);
						$hosters= array();
						while($tmp_hoster = mysql_fetch_array($result)) $hosters[$tmp_hoster['id']] = $tmp_hoster;
					}

					$sql	= 'SELECT * FROM fs_series_links WHERE sid='.intval($serieSID).' AND ssid='.intval($serieSSID);
					$result	= SQL::sendQuery($sql);
					$episode_hosters= array();
					while($tmp_hoster = mysql_fetch_array($result)) $episode_hosters[$tmp_hoster['eid']][] = $tmp_hoster;
					
					for($episode_id=1; $episode_id<=$seasons[$serieSSID]['episodes']; $episode_id++)
					{
						if(isset($episodes[$episode_id])) $episode = $episodes[$episode_id];
						else $episode = array('id'=>0,'sid'=>intval($serieSID),'ssid'=>intval($serieSSID),'eid'=>intval($episode_id),'name_de'=>'Unbekannt','name_en'=>'Unknown','description'=>0);
						
						if(intval(@$seasons_watched[$serieSSID]['episode'][$episode['eid']]) == 1) $gesehen = true;
						else $gesehen = false;
						if($gesehen == true) echo '<tr class="success">';
						else if(sizeof(@$episode_hosters[$episode['eid']]) == 0) echo '<tr class="error">';
						else echo '<tr>';
						echo '
							<td>'.$episode['eid'].'</td>
							<td>';
							if($gesehen) echo LANG::getData('season')->episode->status_viewed;
							else echo LANG::getData('season')->episode->status_new;
							echo '</td>
							<td><strong>';
							if(strlen($episode['name_de']) >= 1) echo htmlspecialchars($episode['name_de']);
							else echo 'Unbekannt';
							echo '</strong> - <i>';
							if(strlen($episode['name_en']) >= 1) echo htmlspecialchars($episode['name_en']);
							else echo 'Unknown';
							echo '</i></td>
							<td>';
								$total_hosters = 0;
								foreach($hosters as $hoster)
								{
									if(isset($episode_hosters[$episode['eid']]))
									{
										foreach($episode_hosters[$episode['eid']] as $link)
										{
											if(intval($hoster['id']) == intval($link['hoster']))
											{
												echo '<a href="index.php?page=series.season&id='.$serieSID.'&ssid='.$serieSSID.'&eid='.intval($episode['eid']).'&serie_lid='.intval($link['id']).'&action=view#stream"><img src="img/icons/'.$hoster['icon_name'].'.png"/><img src="img/icons/'.LANG::$languages[$link['lid']]['icon_name'].'.png"/>';
												if(intval($link['lid_subtitle']) >= 1) echo '<img src="img/icons/'.LANG::$languages[$link['lid_subtitle']]['icon_name'].'.png"/>';
												echo '</a> ';
												$total_hosters++;
											}
										}
									}
								}
								if(!$total_hosters) echo LANG::getData('season')->episode->no_hosters;
							echo '</td>
						</tr>';
					}
									echo '</tbody>
								</table>
							</div>
						</div>
					</div>';
					if(@$_GET['action'] == 'view')
					{
						echo '<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseEpisodeStream">
									'.LANG::getData('season')->stream->title.'
								</a>
							</div>
						<div id="collapseEpisodeStream" class="accordion-body collapse in">
								<div class="accordion-inner">
								<a name="stream"></a>';
									if(sizeof(@$episode_hosters[$serieEID]) == 0) echo '<div class="alert alert-error">'.LANG::getData('season')->episode->no_hosters.'</div>';
									else
									{
										$sql	= 'SELECT * FROM fs_series_links WHERE id='.intval($serieLID).' AND sid='.intval($serieSID).' AND eid='.intval($serieEID);
										$result	= SQL::sendQuery($sql);
										$link = mysql_fetch_array($result);
										if(!mysql_num_rows($result) || !isset($hosters[$link['hoster']]['embed_format']) || !isset($link['link_id'])) echo '<div class="alert alert-error">Ungültiger Link</div>';
										else
										{
											if(USER::isLoggedIn())
											{
												$sql = 'DELETE FROM fs_user_has_watched WHERE userID='.intval(USER::$user['userID']).' AND sid='.intval($serieSID).' AND ssid='.intval($serieSSID).' AND eid='.intval($serieEID);
												SQL::sendQuery($sql);
												$sql = 'INSERT INTO fs_user_has_watched (userID,sid,ssid,eid,timestamp) VALUES ('.intval(USER::$user['userID']).','.intval($serieSID).','.intval($serieSSID).','.intval($serieEID).','.time().')';
												SQL::sendQuery($sql);
											}
											$sql = 'UPDATE fs_series SET total_views=total_views+1 WHERE id='.intval($serieSID);
											SQL::sendQuery($sql);
											
											echo '
											<span class="span4">
											</span>
											<span class="span4">
												<a href="#modalStreamView" role="button" class="btn" data-toggle="modal">
													<h3>'.$serie['name'].'</h3>
													<p>
														Staffel '.intval($serieSSID).', Episode '.intval($serieEID).'<br>
														Hoster: '.$hosters[$link['hoster']]['name'].' (<img src="img/icons/'.$hosters[$link['hoster']]['icon_name'].'.png"/><img src="img/icons/'.LANG::$languages[$link['lid']]['icon_name'].'.png"/>';
														if(intval($link['lid_subtitle']) >= 1) echo '<img src="img/icons/'.LANG::$languages[$link['lid_subtitle']]['icon_name'].'.png"/>';
														echo ')<br/>
														<strong>Hier klicken, um die Episode zu gucken</strong>
													</p>
												</a>
											</span>
											<span class="span4">
											</span>
											<div id="modalStreamView" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modalStreamViewLabel" aria-hidden="true" style="width:650px;height:500px">
												<div class="modal-header">
													<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
													<h3 id="modalStreamViewLabel">Stream</h3>
												</div>
												<div class="modal-body">
													<p>';
														$loop = 1;
														$id_arr = explode(';',$link['link_id']);
														foreach($id_arr as $link_id)
														{
															if(empty($link_id)) continue;
															if($hosters[$link['hoster']]['embed'] == 1)
															{
																echo '<h3>'.$hosters[$link['hoster']]['name'].' - S'.intval($serieSSID).'E'.intval($serieEID);
																if((sizeof($id_arr)-2) >= 2) echo 'Part '.$loop.'/'.(sizeof($id_arr)-2);
																echo '</h3><iframe src="'.sprintf($hosters[$link['hoster']]['embed_format'],$link_id).'" width="600" height="400" frameborder="0" style="overflow: hidden"></iframe>';
															}
															else
															{
																echo '<a href="'.sprintf($hosters[$link['hoster']]['embed_format'],$link_id).'"><button type="button" class="btn">'.$hosters[$link['hoster']]['name'].' - S'.intval($serieSSID).'E'.intval($serieEID);
																if((sizeof($id_arr)-2) >= 2) echo 'Part '.$loop.'/'.(sizeof($id_arr)-2);
																echo '</button></a><br/>';
															}
															$loop++;
														}
														if(USER::hasUserPermission('canReportLinks'))
														{
															$sql		= 'SELECT COUNT(*) FROM fs_series_reported_links WHERE lid='.$link['id'].' AND status=0';
															$result		= SQL::sendQuery($sql);
															$reported	= (bool)mysql_result($result,0);
														}
														else $reported = true;
													echo '</p>
												</div>
												<div class="modal-footer">';
													if(!$reported) echo '<a href="#modalLinkBroken" data-dismiss="modal" data-toggle="modal"><button type="button" class="btn btn-danger">Link defekt</button></a>';
													echo '<button class="btn" data-dismiss="modal" aria-hidden="true">'.LANG::getData('season')->general->close.'</button>
												</div>
											</div>';
											if(!$reported) echo '
											<div id="modalLinkBroken" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modalLinkBrokenLabel" aria-hidden="true">
												<div class="modal-header">
													<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
													<h3 id="modalLinkBrokenLabel">Stream</h3>
												</div>
												<form action="index.php?page=series.season&id='.intval($serieSID).'&ssid='.intval($serieSSID).'" method="post">
													<div class="modal-body">
														<p>
															<input type="hidden" name="action"		value="report_link"/>
															<input type="hidden" name="fs_token"	value="'.USER::$user['fs_token'].'"/>
															<input type="hidden" name="brokenSID"	value="'.intval($serieSID).'"/>
															<input type="hidden" name="brokenSSID"	value="'.intval($serieSSID).'"/>
															<input type="hidden" name="brokenEID"	value="'.intval($serieEID).'"/>
															<input type="hidden" name="brokenLID"	value="'.intval($link['id']).'"/>
															<div class="alert alert-error">Die Verlinkung funktioniert nicht mehr oder enthält inkorrekte Informationen?</div>
															<h3><strong>Bitte kreuze den Grund deiner Meldung an:</strong></h3>
															<input type="radio" name="brokenReason" value="1" checked> Link ist defekt<br/>
															<input type="radio" name="brokenReason" value="2"> Falsche Staffel/Episode<br/>
															<input type="radio" name="brokenReason" value="3"> Sprache/Untertitel ist inkorrekt<br/>
															<input type="radio" name="brokenReason" value="4"> Unzureichende Qualität<br/>
															<h3><strong>Weitere Informationen:</strong></h3>
															<textarea rows="3" class="span12" name="brokenAdditionalInformation">z.B. welche falsche Staffel/Episode o.ä.</textarea>
														</p>
													</div>
													<div class="modal-footer">
														<button class="btn btn-primary" type="submit">Bericht senden</button>
														<button class="btn" data-dismiss="modal" aria-hidden="true">'.LANG::getData('season')->general->close.'</button>
													</div>
												</form>
											</div>';
										}
									}
								echo '</div>
							</div>
						</div>';
					}
					if(USER::isLoggedIn() && USER::hasUserPermission('canAddLinks'))
					{
						echo '
							<div class="accordion-group">
								<div class="accordion-heading">
									<a class="accordion-toggle" data-toggle="modal" data-parent="#accordion" href="#modalAddLinks">
										Link adden
									</a>
								</div>
							</div>
						</div>
						<div id="modalAddLinks" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modalAddLinksLabel" aria-hidden="true">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
								<h3 id="modalAddLinksLabel">Links hinzufügen</h3>
							</div>
							<form action="index.php?page=series.season&id='.intval($serieSID).'&ssid='.intval($serieSSID).'" method="post">
								<div class="modal-body">
									<p>
										<input type="hidden" name="action"		value="addlink">
										<input type="hidden" name="serieSID"	value="'.intval($serieSID).'">
										<input type="hidden" name="fs_token"	value="'.USER::$user['fs_token'].'">
										<div id="addLink_1" class="alert alert-info">
											<div class="input-prepend span3">
												<span class="add-on">Staffel</span>
												<input class="span6" name="addLink[1][season]" type="text" value="'.intval($serieSSID).'">
											</div>
											<div class="input-prepend span3">
												<span class="add-on">Episode</span>
												<input class="span6" name="addLink[1][episode]" type="text" value="'.intval($serieEID).'">
											</div>
											<div class="input-prepend span5">
												<span class="add-on">ID</span>
												<input class="span12" name="addLink[1][id]" type="text" placeholder="LINK-IDs">
											</div>
											<br/>
											<select name="addLink[1][hoster]" class="span6">
												<option value="0">Hoster</option>';
												foreach($hosters as $hoster) echo '<option value="'.$hoster['id'].'">'.htmlspecialchars($hoster['name']).'</option>';
												echo '
											</select>
											<select name="addLink[1][anon]" class="span6">
												<option value="0">Anonym bleiben</option>
												<option value="1">Usernamen veröffentlichen</option>
											</select>
											<br/>
											<select name="addLink[1][lid]" class="span6">';
													foreach(LANG::$languages as $language) echo '<option value="'.$language['id'].'">Sprache: '.htmlspecialchars($language['shortcut']).' - '.htmlspecialchars($language['name']).'</option>';
											echo '</select>
											<select name="addLink[1][lid_subtitle]" class="span6">
												<option value="0">Keine Untertitel</option>';
													foreach(LANG::$languages as $language)echo '<option value="'.$language['id'].'">Untertitel: '.htmlspecialchars($language['shortcut']).' - '.htmlspecialchars($language['name']).'</option>';
											echo '
											</select>
											<br/>
										</div>
										<div align="center"><button type="button" class="btn" onclick="addLinkField(1);">Weiteren Link</button></div>';
										?>
										<script>
											var staticID = 1
											function addLinkField(i)
											{
												lastID = staticID
												staticID = staticID + 1
												$("#addLink_"+lastID).after(
													'<div id="addLink_'+staticID+'" class="alert alert-info">'+
														'<div class="input-prepend span3">'+
															'<span class="add-on">Staffel</span>'+
															'<input class="span6" name="addLink['+staticID+'][season]" type="text" value="<?php echo intval($serieSSID); ?>">'+
														'</div>'+
														'<div class="input-prepend span3">'+
															'<span class="add-on">Episode</span>'+
															'<input class="span6" name="addLink['+staticID+'][episode]" type="text" value="<?php echo intval($serieEID); ?>">'+
														'</div>'+
														'<div class="input-prepend span5">'+
															'<span class="add-on">ID</span>'+
															'<input class="span12" name="addLink['+staticID+'][id]" type="text" placeholder="LINK-IDs">'+
														'</div>'+
														'<br/>'+
														'<select name="addLink['+staticID+'][hoster]" class="span6">'+
															'<option value="0">Hoster</option>'+
															<?php
																foreach($hosters as $hoster) echo "'<option value=\"".$hoster['id']."\">".htmlspecialchars($hoster['name'])."</option>'+\n";
															?>
														'</select>'+
														'<select name="addLink['+staticID+'][anon]" class="span6">'+
															'<option value="0">Anonym bleiben</option>'+
															'<option value="1">Usernamen veröffentlichen</option>'+
														'</select>'+
														'<br/>'+
														'<select name="addLink['+staticID+'][lid]" class="span6">'+
															<?php
																foreach(LANG::$languages as $language) echo "'<option value=\"".$language['id']."\">Sprache: ".htmlspecialchars($language['shortcut'])." - ".htmlspecialchars($language['name'])."</option>'+\n";
															?>
														'</select>'+
														'<select name="addLink['+staticID+'][lid_subtitle]" class="span6">'+
															'<option value="0">Keine Untertitel</option>'+
															<?php
																foreach(LANG::$languages as $language)echo "'<option value=\"".$language['id']."\">Untertitel: ".htmlspecialchars($language['shortcut'])." - ".htmlspecialchars($language['name'])."</option>'+\n";
															?>
														'</select>'+
														'<br/>'+
													'</div>'
												)
											};
										</script>
									</p>
								</div>
								<div class="modal-footer">
									<button class="btn btn-primary">Senden</button>
									<button class="btn" data-dismiss="modal" aria-hidden="true">Schließen</button>
								</div>
							</form>
						</div>
						<?php
					}
					echo '</div>
					</div>';
				}
			}
?>
	</div>
</div>